<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>叫貨明細</title>
<style>
:root{--border:#e5e7eb;--muted:#6b7280;--text:#111827;--ok:#059669;--bad:#b91c1c;--brand:#3b82f6;--bg:#f8fafc;--surface:#fff}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,sans-serif;
  color:var(--text);background:var(--bg);
  -webkit-tap-highlight-color:transparent;
  padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)
}
.wrap{max-width:840px;margin:32px auto;padding:0 12px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.06);padding:20px}
h1{margin:0 0 14px;text-align:center;letter-spacing:.08em;font-weight:800;font-size:22px}
.hint{color:var(--muted);margin:0 0 12px;font-size:14px}

/* Mobile-first 表格：每列上下堆疊 */
.table{width:100%;border-collapse:collapse;table-layout:auto;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--surface)}
.table tbody tr{display:block;border-bottom:1px solid var(--border);padding:10px 12px}
.table tbody tr:last-child{border-bottom:0}
.table th,.table td{display:block;padding:0;vertical-align:top;word-break:break-word}
.table th{margin:0 0 6px;color:#111827;font-weight:700;font-size:13px}
.table td{font-size:15px;line-height:1.6}
.muted{color:var(--muted)}
.prewrap{white-space:pre-wrap}

/* 狀態與提示 */
.footline{margin-top:12px;border-left:4px solid var(--brand);padding:10px 12px;color:var(--muted);border-radius:8px;background:#f8fbff;font-size:14px}
.ok{color:var(--ok)}.bad{color:var(--bad)}
.notice{margin-top:16px;background:#f0f9ff;border:1px solid #dbeafe;border-radius:12px;padding:14px}
.warn{background:#fff7ed;border-color:#ffedd5}
.small{font-size:14px}
code{background:#f3f4f6;border:1px solid var(--border);padding:2px 6px;border-radius:6px}

/* 區塊 */
.bank{margin-top:12px}
.bank h3{margin:0 0 8px;font-size:18px}
.row{display:flex;gap:10px;flex-direction:column}
.kv{display:flex;align-items:center;justify-content:space-between;gap:8px;background:#f9fafb;border:1px solid var(--border);padding:12px;border-radius:12px}
.kv b{font-size:14px}

/* 按鈕 */
.btn{cursor:pointer;border:1px solid var(--border);background:#fff;border-radius:10px;padding:10px 14px;font-size:15px;touch-action:manipulation;min-width:120px}
.btn:active{transform:translateY(1px)}
.btn-primary{background:#2563eb;border-color:#2563eb;color:#fff}

/* 置頂固定操作列 */
.sticky-actions{
  position:sticky; top:0; z-index:30;
  margin:12px -10px 0;
  padding:10px;
  background:#ffffffF2; backdrop-filter:blur(6px);
  border:1px solid var(--border); border-left:0; border-right:0;
  display:flex; gap:10px; flex-wrap:wrap;
}
.sticky-actions .btn{flex:1}

/* 手機置中（清單維持左對齊較好讀） */
@media (max-width: 480px){
  .table th,.table td{ text-align:center; }
  .table td .orders-list{ display:inline-block; text-align:left; }
}

@media (min-width:640px){
  .wrap{margin:48px auto;padding:0 16px}
  .card{padding:28px}
  h1{font-size:28px}
  .table{table-layout:fixed}
  .table tbody tr{display:table-row;padding:0}
  .table th,.table td{display:table-cell;padding:14px 16px;border-bottom:1px solid var(--border)}
  .table th{width:28%;background:#f9fafb}
  .table tbody tr:last-child th,.table tbody tr:last-child td{border-bottom:0}
  .row{flex-direction:row}
  .sticky-actions{margin-left:-16px;margin-right:-16px}
}

/* 商品明細：數字清單（畫面） */
.orders-list{margin:0;padding-left:1.5em;list-style:decimal;list-style-position:outside}
.orders-list li{margin:3px 0;line-height:1.6}
</style>

<!-- 一鍵截圖用 -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
</head>
<body>
<div class="wrap">
  <!-- 標記截圖範圍 -->
  <div class="card" data-capture="order">
    <h1>叫貨明細</h1>
    <p class="hint">以下為本次訂單資訊：</p>

    <!-- 匯款資訊（上方） -->
    <div class="notice bank">
      <h3>匯款資訊</h3>
      <div class="row">
        <div class="kv" aria-label="銀行代號"><b>銀行代號</b><span id="bank_code_txt">824（連線銀行）</span></div>
        <div class="kv" aria-label="銀行帳號">
          <b>銀行帳號</b><span id="bank_acct_txt" style="font-variant-numeric:tabular-nums">111013782313</span>
          <button id="copyBtn" class="btn" type="button">複製帳號</button>
        </div>
      </div>
      <ul class="small" style="margin:10px 0 0 18px;line-height:1.7">
        <li>下單後，<b>收到款項</b>進行出貨（約 <b>3–5 個工作天</b>）。</li>
        <li>如需開立發票/收據，需加收<b>營業稅 5%</b>。</li>
        <li>匯款後請提供<b>後五碼</b>傳送至總部官方帳號。</li>
      </ul>
    </div>

    <!-- 置頂固定操作列 -->
    <div class="sticky-actions">
      <button id="btnSendLast5" class="btn btn-primary" type="button">上傳後五碼（開啟 LINE）</button>
      <button id="snapBtn" class="btn" type="button">一鍵截圖訂單</button>
    </div>

    <div id="guardMsg" class="notice warn small" style="display:none;"></div>
    <p id="resultLine" class="footline">正在檢查必要欄位…</p>
    <!-- 新增：顯示 GAS 寫入結果（其餘原樣） -->
    <p id="gasLine" class="footline">等待寫入 Google 試算表…</p>

    <!-- 訂單明細表格 -->
    <table class="table">
      <tbody>
        <tr><th>訂單時間</th><td id="order_time"     class="muted">（空）</td></tr>
        <tr><th>訂單編號</th><td id="order_id"       class="muted">（空）</td></tr>
        <tr><th>信箱</th><td     id="email"          class="muted">（空）</td></tr>
        <tr><th>分店名稱</th><td id="store_name"     class="muted">（空）</td></tr>
        <tr><th>寄貨方式</th><td id="delivery_method"class="muted">（空）</td></tr>
        <tr><th>取貨備註</th><td id="pickup_note"    class="muted">（空）</td></tr>
        <tr><th>商品明細</th><td id="orders"         class="muted prewrap">（空）</td></tr>
        <tr><th>實際運費</th><td id="shipping_fee"   class="muted">（空）</td></tr>
        <tr><th>總計金額</th><td id="total_amount"   class="muted">（空）</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
// ====== 你只需要改這裡（Make 設定）======
const MAKE_WEBHOOK_URL = "https://hook.eu2.make.com/mxd447qyeae62is1m1vsutndp3bqhudf";
const LINE_ADD_FRIEND_URL = "https://lin.ee/RTMwUYu";

// ====== 新增：GAS Web App 設定（其餘原碼不動）======
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwFXLQu-n8T3_GUYKTWzlyO77vtZLKxqV82J22QK8EiCr9cecKuUqXYItPhUMx-z47N/exec"; // 你的 GAS
const GAS_TOKEN    = ""; // 若 Code.gs 有 SECRET_TOKEN，這裡填同一組；否則留空
// ===============================================

// 英文鍵 → 內部標準鍵
const enToStd = {
  order_time:'order_time', order_id:'order_id', email:'email',
  store_name:'store_name', delivery_method:'delivery_method',
  pickup_note:'pickup_note', order_details:'orders',
  shipping:'shipping_fee', total:'total_amount'
};
// 中文欄位名 → 內部標準鍵
const zhToStd = {
  "訂單時間":"order_time","訂單編號":"order_id","信箱":"email","分店名稱":"store_name",
  "寄貨方式":"delivery_method","取貨備註":"pickup_note","商品明細":"orders",
  "實際運費":"shipping_fee","總計金額":"total_amount"
};

// ------ 工具 ------
function setCell(id,val){ const el=document.getElementById(id); const v=(val==null||val==='')?'（空）':String(val); el.textContent=v; el.classList.toggle('muted',v==='（空）'); }
function isValidEmail(s){ return !!(s && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.trim())); }
function showGuard(html){ const box=document.getElementById('guardMsg'); box.style.display='block'; box.innerHTML=html; }
function hideGuard(){ const box=document.getElementById('guardMsg'); box.style.display='none'; box.innerHTML=''; }
function setCellHTML(id, html){ const el=document.getElementById(id); const ok = html && String(html).trim()!==''; if(ok){ el.innerHTML=html; el.classList.remove('muted'); } else { el.textContent='（空）'; el.classList.add('muted'); } }
function escapeHTML(s){
  return String(s||'').replace(/[&<>\"']/g, function(m){
    return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
  });
}

// 取得 query（支援 ? 與 #；容忍前面 ?&）
function getQueryString(){
  let raw = '';
  if (location.search && location.search.startsWith('?')) raw = location.search.slice(1);
  if (!raw && location.hash){
    const h = location.hash;
    const qPos = h.indexOf('?');
    raw = (qPos >= 0) ? h.slice(qPos+1) : (h.startsWith('#') ? h.slice(1) : h);
  }
  return String(raw||'').replace(/^\?*&+/, '').trim();
}
// 安全解碼（容忍未編碼空白與全形字）
function safeDecode(str){
  try { return decodeURIComponent(String(str||'').replace(/\+/g,' ')); }
  catch { return String(str||'').replace(/\+/g,' '); }
}

// ★ 解析網址（英文鍵=值／中文鍵=值／值=中文鍵 都支援）
function readParamsStd(){
  const std = {};
  const raw = getQueryString();
  if (!raw) return std;

  const pairs = raw.split('&').filter(Boolean);
  for (const pair of pairs){
    const eq = pair.lastIndexOf('=');
    let left = pair, right = '';
    if (eq >= 0){ left = pair.slice(0, eq); right = pair.slice(eq+1); }

    const L = safeDecode(left).trim();
    const R = safeDecode(right).trim();
    if (!L && !R) continue;

    if (L in enToStd && R !== ''){ const k=enToStd[L]; if (std[k]==null||std[k]==='') std[k]=R; continue; }
    if (L in zhToStd && R !== ''){ const k=zhToStd[L]; if (std[k]==null||std[k]==='') std[k]=R; continue; }
    if (R in zhToStd && L !== ''){ const k=zhToStd[R]; if (std[k]==null||std[k]==='') std[k]=L; continue; }
  }
  return std;
}

/* ===== 商品明細解析（保留括號；x/X/×；可含 = 金額；穩定分段） ===== */
const ALLOWED_TAGS = new Set(['整件','單品項']);

function parseOrders(raw){
  let t = String(raw || '').replace(/\s+/g,' ').trim();
  if (!t) return [];

  // 去掉尾端殘留乘號（例如 "... = $600 ×"）
  t = t.replace(/\s*[xX×]\s*$/, '');

  // 在「×/x + 數量 +（可選）= 金額」後、若後面接下一個品項（中文/括號/英文），插入分隔符 |
  t = t.replace(
    /([xX×]\s*\d+(?:\s*=\s*[\$＄]?\s*[\d,]+)?)(?=\s*(?:[（(]|[A-Za-z\u4E00-\u9FFF]))/g,
    '$1|'
  );

  const chunks = t.split('|').map(s => s.trim()).filter(Boolean);
  const items = [];

  for (const ch of chunks){
    // 可選標籤 + 品名 + ×/x 數量 +（可選）= 金額
    const m = ch.match(
      /^(?:[（(]\s*([^（）)]+?)\s*[）)])?\s*(.*?)\s*[xX×]\s*(\d+)(?:\s*=\s*([\$＄]?\s*[\d,]+))?\s*$/
    );
    if (m){
      let tag   = (m[1] || '').trim();
      const name  = (m[2] || '').trim().replace(/\s*[xX×]\s*$/,'');
      const qty   = (m[3] || '').trim();
      const price = (m[4] || '').trim();
      if (!ALLOWED_TAGS.has(tag)) tag = '';
      items.push({ name, qty, tag, price });
    }else{
      items.push({ name: ch.replace(/\s*[xX×]\s*$/,''), qty:'', tag:'', price:'' });
    }
  }
  return items;
}

function formatOrdersHTML(raw){
  const items = parseOrders(raw);
  if(!items.length) return '';
  const lis = items.map(it=>{
    const tag   = it.tag ? `（${escapeHTML(it.tag)}）` : '';
    const price = it.price ? ` = ${escapeHTML(it.price)}` : '';
    return `<li>${tag}${escapeHTML(it.name)} × ${escapeHTML(it.qty)}${price}</li>`;
  }).join('');
  return `<ol class="orders-list">${lis}</ol>`;
}

// Email 專用 HTML 清單（inline style）
function formatOrdersHTML_email(raw){
  const items = parseOrders(raw);
  if(!items.length) return '';
  const lis = items.map(it=>{
    const tag   = it.tag ? `（${escapeHTML(it.tag)}）` : '';
    const price = it.price ? ` = ${escapeHTML(it.price)}` : '';
    return `<li style="margin:3px 0;line-height:1.6">${tag}${escapeHTML(it.name)} × ${escapeHTML(it.qty)}${price}</li>`;
  }).join('');
  return `<ol style="margin:0;padding-left:1.5em;list-style:decimal;list-style-position:outside">${lis}</ol>`;
}

// 純文字（含換行），給 LINE 與 EmailJS（pre-line 顯示）
function formatOrdersText(raw){
  const items = parseOrders(raw);
  return items.map((it,i)=>
    `${i+1}. ${it.tag?`（${it.tag}）`:''}${it.name} × ${it.qty}${it.price?` = ${it.price}`:''}`
  ).join('\n');
}

// 讓多行文字變成 JSON-safe（\\n 兩個字元）
function jsonSafeNewlines(s){
  return String(s||'').replace(/\r/g,'').replace(/\n/g,'\\n');
}

// 組訂單 payload（同時輸出三種格式）
function buildOrderPayload(std){
  const textList = formatOrdersText(std.orders||''); // 多行純文字 (含真正換行)
  return {
    '訂單時間':std.order_time||'',
    '訂單編號':std.order_id||'',
    '信箱':std.email||'',
    '分店名稱':std.store_name||'',
    '寄貨方式':std.delivery_method||'',
    '取貨備註':std.pickup_note||'',

    // 三種型態
    '商品明細': textList,                          // 人看用（真換行）
    '商品明細_json': jsonSafeNewlines(textList),    // 給 HTTP Raw JSON（\\n 兩字元）
    'order_details_html': formatOrdersHTML_email(std.orders||''), // EmailJS HTML
    
    '實際運費':std.shipping_fee||'',
    '總計金額':std.total_amount||'',

    // 英文鍵原樣保留
    order_time:std.order_time||'',
    order_id:std.order_id||'',
    email:std.email||'',
    store_name:std.store_name||'',
    delivery_method:std.delivery_method||'',
    pickup_note:std.pickup_note||'',
    orders:std.orders||'',
    shipping_fee:std.shipping_fee||'',
    total_amount:std.total_amount||'',

    _source_url:location.href
  };
}

// 貼到 LINE（商品明細→多行數字條列）
function buildLineText(std){
  const lines = [
    '【匯款後五碼回報】',
    `訂單時間：${std.order_time||''}`,
    `訂單編號：${std.order_id||''}`,
    `分店名稱：${std.store_name||''}`,
    `信箱：${std.email||''}`,
    `寄貨方式：${std.delivery_method||''}`,
    `取貨備註：${std.pickup_note||''}`,
    '商品明細：',
    formatOrdersText(std.orders||''),
    '',
    `實際運費：${std.shipping_fee||''}`,
    `總計金額：${std.total_amount||''}`,
    `匯款後五碼：`
  ];
  return lines.join('\n');
}

// 開啟 LINE 並貼上
async function openLineAndPaste(text){
  try{ await navigator.clipboard.writeText(text); }
  catch{
    const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove();
  }
  alert('已複製訂單明細。\n將為你開啟 LINE，請貼上並補上「匯款後五碼」。');
  const deep = "line://msg/text/" + encodeURIComponent(text);
  try{
    const a=document.createElement('a'); a.href=deep; a.style.display='none';
    document.body.appendChild(a); a.click(); setTimeout(()=>a.remove(),1500);
  }catch{}
  setTimeout(()=>{ window.location.href = LINE_ADD_FRIEND_URL; },800);
}

// 背景送 Make（含去重）
async function postOrderToMake(payload){
  try{
    // === 去重：以「訂單編號」為唯一鍵，存於 LocalStorage ===
    const orderId = payload.order_id || payload["訂單編號"];
    if (orderId) {
      const KEY = "sentOrders";
      const sentOrders = JSON.parse(localStorage.getItem(KEY) || "[]");
      if (sentOrders.includes(orderId)) {
        console.warn("⚠️ 訂單重複，不再觸發 Make：", orderId);
        document.getElementById('resultLine').innerHTML = '⚠️ <span class="bad">重複訂單</span>未再次通知總部';
        return; // 直接結束，不送 Make
      }
      // 記錄這筆訂單編號（先寫再送，避免重複點擊造成二次觸發）
      sentOrders.push(orderId);
      // 可選：控制陣列長度，避免無限成長（只保留最近 300 筆）
      if (sentOrders.length > 300) sentOrders.splice(0, sentOrders.length - 300);
      localStorage.setItem(KEY, JSON.stringify(sentOrders));
    }

    // === 原本送 Make 的流程 ===
    console.log('[MAKE payload]', payload);
    window.lastPayload = payload;

    await fetch(MAKE_WEBHOOK_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({__emailjs__:payload})
    });
    document.getElementById('resultLine').innerHTML='✅ <span class="ok">成功</span>寄通知給總部';
  }catch{
    document.getElementById('resultLine').innerHTML='❌ <span class="bad">失敗</span>寄通知給總部';
  }
}

/* ====== 新增：轉發到 GAS Web App（顯示成功 / 已重複 / 錯誤） ====== */
async function forwardToGAS(){
  const line = document.getElementById('gasLine');
  try{
    const qs = getQueryString();
    if(!GAS_ENDPOINT){
      line.innerHTML = '⛔ 未設定 GAS_ENDPOINT';
      return;
    }
    const url = GAS_ENDPOINT + '?' + qs + (GAS_TOKEN ? ('&token='+encodeURIComponent(GAS_TOKEN)) : '');
    line.textContent = '已連線後台，寫入中…';
    const res = await fetch(url, { method:'GET' });
    const j = await res.json().catch(()=>null);
    if(!j){
      line.innerHTML = '❌ <span class="bad">後台回應解析失敗</span>';
      return;
    }
    if(j.ok && j.mode === 'save'){
      if(j.duplicate){
        line.innerHTML = '⚠️ <span class="ok">已處理</span>：重複開啟，本次不重複寫入（' + (j.reason||'') + '）';
      }else{
        line.innerHTML = '✅ <span class="ok">已寫入</span>：第 ' + j.row + ' 列';
      }
    }else if(j.ok){
      line.innerHTML = '✅ <span class="ok">操作成功</span>（' + (j.mode||'') + '）';
    }else{
      line.innerHTML = '❌ <span class="bad">寫入失敗</span>：' + (j.error||'');
    }
  }catch(err){
    line.innerHTML = '❌ <span class="bad">連線錯誤</span>：' + (err && err.message || err);
  }
}

/* ====== 一鍵截圖下載 ====== */
async function captureAndDownload(){
  const btnSnap = document.getElementById('snapBtn');
  const btnLine = document.getElementById('btnSendLast5');
  const target =
    document.querySelector('[data-capture="order"]') ||
    document.querySelector('.card') || document.body;

  const prev1 = btnSnap ? btnSnap.style.visibility : '';
  const prev2 = btnLine ? btnLine.style.visibility : '';
  if(btnSnap) btnSnap.style.visibility = 'hidden';
  if(btnLine) btnLine.style.visibility = 'hidden';

  window.scrollTo({ top: 0, behavior: 'instant' });
  const scale = Math.min(2, window.devicePixelRatio || 1.5);

  try{
    const canvas = await html2canvas(target, {
      backgroundColor:'#ffffff',
      scale,
      useCORS:true,
      allowTaint:false,
      logging:false,
      windowWidth:document.documentElement.scrollWidth,
      windowHeight:document.documentElement.scrollHeight
    });

    const a = document.createElement('a');
    const ts = new Date();
    const pad = n => String(n).padStart(2,'0');
    const id = (window.std && window.std.order_id) ? String(window.std.order_id) : '未命名';
    const filename = `訂單明細_${id}_${ts.getFullYear()}-${pad(ts.getMonth()+1)}-${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.png`;
    a.download = filename;
    a.href = canvas.toDataURL('image/png');
    document.body.appendChild(a);
    a.click();
    a.remove();
  }catch(err){
    alert('截圖失敗：' + err.message);
    console.error(err);
  }finally{
    if(btnSnap) btnSnap.style.visibility = prev1;
    if(btnLine) btnLine.style.visibility = prev2;
  }
}

// 啟動
(function init(){
  const std = readParamsStd();
  window.std = std;

  // 畫面顯示：用 HTML 清單
  setCell('order_time',std.order_time); setCell('order_id',std.order_id); setCell('email',std.email);
  setCell('store_name',std.store_name); setCell('delivery_method',std.delivery_method);
  setCell('pickup_note',std.pickup_note);
  setCellHTML('orders', formatOrdersHTML(std.orders||'')); // 畫面：清單化
  setCell('shipping_fee',std.shipping_fee); setCell('total_amount',std.total_amount);

  // ★ 新增：不論 email 是否有效，都先把參數轉發到 GAS（由 GAS 端去重與寫入）
  forwardToGAS();

  // 訂單通知防呆（需要有效 email）→ 僅影響「寄總部通知」這一段
  if(!isValidEmail(std.email)){
    showGuard('未檢測到有效的 <b>信箱</b>，本次不會通知總部（避免寄出空白/錯誤資料）。<br>請確認 Glide 帶入參數包含 <code>email</code> 或顛倒格式中含「信箱」。');
    document.getElementById('resultLine').innerHTML='⛔ 已停止通知：缺少有效信箱。';
  }else{
    hideGuard();
    document.getElementById('resultLine').innerHTML='已檢核通過，正在通知總部…';
    postOrderToMake(buildOrderPayload(std));
  }

  // 事件：複製銀行帳號
  document.getElementById('copyBtn')?.addEventListener('click', async (e)=>{
    const btn=e.currentTarget; const acct=document.getElementById('bank_acct_txt').textContent.trim();
    try{ await navigator.clipboard.writeText(acct); btn.textContent='已複製！'; setTimeout(()=> btn.textContent='複製帳號',1200);}catch{}
  });

  // 事件：上傳後五碼（開啟 LINE）
  document.getElementById('btnSendLast5')?.addEventListener('click', ()=>{
    openLineAndPaste(buildLineText(std));
  });

  // 事件：一鍵截圖訂單
  document.getElementById('snapBtn')?.addEventListener('click', captureAndDownload);
})();
</script>
</body>
</html>
